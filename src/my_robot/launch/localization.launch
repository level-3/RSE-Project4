<?xml version="1.0" encoding="UTF-8"?>

<launch>

  <!-- Arguments for launch file with defaults provided -->
  <arg name="database_path"     default="$(find my_robot)/db/rtabmap.db"/>
  <arg name="rgb_topic"   default="/camera/rgb/image_raw"/>
  <arg name="depth_topic" default="/camera/depth/image_raw"/>
  <arg name="camera_info_topic" default="/camera/rgb/camera_info"/>  

  <arg name="cfg" default="$(find my_robot)/config/config.ini" /> <!-- To change RTAB-Map's parameters, set the path of config file (*.ini) generated by the standalone app -->


  <!-- Mapping Node -->
  <group ns="rtabmap">
    <node name="rtabmap" pkg="rtabmap_ros" type="rtabmap" output="screen"  >
      

      <!-- Basic RTAB-Map Parameters -->
      <param name="database_path"       type="string" value="$(arg database_path)"/>
      <param name="frame_id"            type="string" value="robot_footprint"/>
      <param name="odom_frame_id"       type="string" value="odom"/>
      <param name="subscribe_depth"     type="bool"   value="true"/>
      <param name="subscribe_scan"      type="bool"   value="true"/>
<!--     <param name="config_path"         type="string" value="$(arg cfg)"/>
--> 
      <!-- RTAB-Map Inputs -->
      <remap from="scan"                        to="/my_robot/laser/scan"/>
      <remap from="rgb/image"                   to="$(arg rgb_topic)"/>
      <remap from="depth/image"                 to="$(arg depth_topic)"/>
      <remap from="rgb/camera_info"             to="$(arg camera_info_topic)"/>



      <!-- RTAB-Map Output -->
      <remap from="grid_map" to="/map"/>

      <!-- Rate (Hz) at which new nodes are added to map -->
      <param name="Rtabmap/DetectionRate" type="string" value="1"/>

      <!-- 2D SLAM -->
      <param name="Reg/Force3DoF" type="string" value="true"/>


      <!-- Loop Closure Detection -->
      <!-- 0=SURF 1=SIFT 2=ORB 3=FAST/FREAK 4=FAST/BRIEF 5=GFTT/FREAK 6=GFTT/BRIEF 7=BRISK 8=GFTT/ORB 9=KAZE -->
      <param name="Kp/DetectorStrategy" type="string" value="6"/>

      <!-- Maximum visual words per image (bag-of-words) -->
      <param name="Kp/MaxFeatures" type="string" value="400"/>

      <!-- Used to extract more or less SURF features -->
      <param name="SURF/HessianThreshold" type="string" value="100"/>

      <!-- Loop Closure Constraint -->
      <!-- 0=Visual, 1=ICP (1 requires scan)-->
      <param name="Reg/Strategy" type="string" value="1"/>

      <!-- Minimum visual inliers to accept loop closure -->
      <param name="Vis/MinInliers" type="string" value="25"/>

      <!-- put robot into localization mode -->
      <param name="Mem/IncrementalMemory" type="string" value="false"/>


      <!--http://wiki.ros.org/rtabmap_ros/Tutorials/Advanced%20Parameter%20Tuning-->

          <!-- 0=Frame-to-Map (F2M) 1=Frame-to-Frame (F2F) -->
          <param name="Odom/Strategy" value="1"/>
          <!-- Correspondences: 0=Features Matching, 1=Optical Flow -->
      <!--  <param name="Vis/CorType" value="0"/>   -->  
          <!-- maximum features map size, default 2000 -->
          <param name="OdomF2M/MaxSize" type="string" value="1000"/> 
          <!-- maximum features extracted by image, default 1000 -->
          <param name="Vis/MaxFeatures" type="string" value="600"/>

          <!--[0=SURF 1=SIFT 2=ORB 3=FAST/FREAK 4=FAST/BRIEF 5=GFTT/FREAK 
          6=GFTT/BRIEF 7=BRISK 8=GFTT/ORB 9=KAZE 10=ORB-OCTREE 
          11=SuperPoint 12=SURF/FREAK 13=GFTT/DAISY 14=SURF/DAISY]-->
          <param name="Vis/FeatureType"                 value="1"/>          

      <param name="GFTT/MinDistance" type="string" value="10"/>

          <!-- RTAB-Map's parameters -->
      <param name="RGBD/NeighborLinkRefining"         value="true"/>
      <param name="RGBD/ProximityBySpace"             value="true"/>
      <param name="RGBD/AngularUpdate"                value="1.0"/>
      <param name="RGBD/LinearUpdate"                 value="1.0"/>
      <param name="RGBD/OptimizeFromGraphEnd"         value="false"/>
      <param name="RGBD/ProximityPathMaxNeighbors"    value="10"/>
      <param name="RGBD/OptimizeMaxError"             value="10"/>


      <param name="Grid/FromDepth"                  value="true"/>
      <param name="Grid/3D"                         value="true"/>  <!--create 3d octomap-->
      <param name="Grid/RayTracing"                 value="true"/>
      <param name="Grid/NoiseFilteringRadius"       value="0.25"/>
      <param name="Grid/NoiseFilteringMinNeighbors" value="8"/>
      <param name="Grid/MaxGroundAngle"             value="45"/>
      <param name="Grid/MaxGroundHeight"            value="0.1"/>
      <param name="Grid/MaxObstacleHeight"          value="2.0"/>
      <param name="Grid/MinClusterSize"             value="20"/>

      <param name="GFTT/BlockSize"                    value="3"/>
      <param name="GFTT/MinDistance"                  value="3"/>
      <param name="GFTT/QualityLevel"                 value="0.001"/>
      <param name="GFTT/UseHarrisDetector"            value="false"/>

    </node>

  <!-- visualization with rtabmapviz    -->
    <node pkg="rtabmap_ros" type="rtabmapviz" name="rtabmapviz" args="-d $(find my_robot)/config/rgbd_gui.ini" output="screen">
        <param name="subscribe_depth"             type="bool" value="true"/>
        <param name="subscribe_scan"              type="bool" value="true"/>
        <param name="frame_id"                    type="string" value="robot_footprint"/>

<!---->
        <remap from="rgb/image"                 to="$(arg rgb_topic)"/>
        <remap from="depth/image"               to="$(arg depth_topic)"/>
        <remap from="rgb/camera_info"           to="$(arg camera_info_topic)"/>
        <remap from="scan"                      to="/my_robot/laser/scan"/>

        <remap from="/rtabmap/odom"                      to="/odom"/>

        
    </node>



  </group>



</launch>